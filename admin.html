<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Admin — Рецепты</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
</head>
<body>
<div class="admin-container">

    <h1 class="admin-title">Админ-панель рецептов</h1>

    <!-- Авторизация -->
    <div class="admin-card-auth">
        <form id="user-info" style="display:none;">
            <div style="margin-bottom:8px;">
                Вы вошли как <strong id="user-email"></strong>
            </div>
            <button id="logout" class="admin-btn admin-btn-secondary">Выйти</button>
            <button class="admin-btn admin-btn-secondary">Назад</button>
        </form>

        <form id="login-form" class="admin-auth">
            <h3>Вход</h3>
            <input id="email" type="email" placeholder="Email" required>
            <input id="password" type="password" placeholder="Пароль" required>
            <button type="submit" class="admin-btn">Войти</button>
        </form>
    </div>

    <!-- Форма рецептов -->
    <div class="admin-card" id="dataInfo">
      <h3>Создать / редактировать рецепт</h3>

      <form id="recipe-form" class="admin-form">
        <input type="hidden" id="recipe-id">

        <label>Название</label>
        <input id="title" required>

        <label>Описание</label>
        <input id="description">

        <label>Время</label>
        <input id="time">

        <label>Ингредиенты (по одному в строке)</label>
        <textarea id="ingredients" rows="12"></textarea>

        <label>Шаги (по одному в строке)</label>
        <textarea id="steps" rows="12"></textarea>

        <label>Картинка</label>
        <div class="image-upload">
          <button type="button" id="select-image-btn" class="admin-btn">Выбрать картинку</button>
          <input id="image-file" type="file" accept="image/*" style="display:none">
          <span id="image-file-name" style="margin-left:8px;font-size:90%;color:#555"></span>
        </div>
        
        <script>
          document.getElementById('select-image-btn').addEventListener('click', () => {
          document.getElementById('image-file').click();
          });
          document.getElementById('image-file').addEventListener('change', (e) => {
          const f = e.target.files[0];
          document.getElementById('image-file-name').textContent = f ? f.name : '';
          });
        </script>
        <hr>
        <div style="display:flex;justify-content:flex-end;margin-top:12px;">
          <button type="submit" class="admin-btn">Сохранить рецепт</button>
        </div>
      </form>
    </div>

    <div class="admin-card">
        <!-- Список рецептов -->
        <h2 class="admin-section-title">Список рецептов</h2>
        <div id="recipes-list"></div>
    </div>
</div>

<script type="module">
import { supabase } from './assets/js/supabase-init.js';

/* ---------------- AUTH ---------------- */

const loginForm = document.getElementById('login-form');
const userInfo = document.getElementById('user-info');
const userEmail = document.getElementById('user-email');
const dataInfo = document.getElementById('dataInfo');

loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if(error) alert(error.message);
});

document.getElementById('logout').onclick = () => supabase.auth.signOut();

supabase.auth.onAuthStateChange((event, session) => {
  if(session){
    loginForm.style.display = 'none';
    userInfo.style.display = '';
    dataInfo.style.display = '';
    userEmail.textContent = session.user.email;
    loadRecipes();
  } else {
    loginForm.style.display = '';
    userInfo.style.display = 'none';
    userEmail.textContent = '';
    dataInfo.style.display = 'none';
    document.getElementById('recipes-list').innerHTML = '';
  }
});

/* ---------------- CRUD ---------------- */

async function loadRecipes(){
  const container = document.getElementById('recipes-list');
  container.innerHTML = 'Загрузка...';

  const { data, error } = await supabase
    .from('recipes')
    .select('*')
    .order('created_at', { ascending: true });

  if(error){
    container.innerHTML = error.message;
    return;
  }

  container.innerHTML = '';
  data.forEach(rec => {
    const div = document.createElement('div');
    div.style.border = "1px solid #ddd";
    div.style.marginBottom = "10px";
    div.style.padding = "10px";
    div.style.borderRadius = "8px";
    div.style.background = "#fafafa";
    div.innerHTML = `
      <div class="recep-title">
        <span class="recep-title-name">${rec.title}</span>
        <button data-id="${rec.id}" class="edit"><i class="fa-regular fa-pen-to-square"></i></button>
        <button data-id="${rec.id}" class="delete"><i class="fa-regular fa-trash-can"></i></button>
      </div>
      <div>${rec.description || ''}</div>
    `;
    container.appendChild(div);
  });

  container.querySelectorAll('.edit').forEach(btn => {
    btn.onclick = () => editRecipe(btn.dataset.id);
  });

  container.querySelectorAll('.delete').forEach(btn => {
    btn.onclick = () => deleteRecipe(btn.dataset.id);
  });
}

async function editRecipe(id){
  const { data } = await supabase
    .from('recipes')
    .select('*')
    .eq('id', id)
    .single();

  document.getElementById('recipe-id').value = data.id;
  document.getElementById('title').value = data.title;
  document.getElementById('description').value = data.description || '';
  document.getElementById('time').value = data.time || '';
  document.getElementById('ingredients').value = (data.ingredients || []).join("\n");
  document.getElementById('steps').value = (data.steps || []).join("\n");

  window.scrollTo({top: 0, behavior: 'smooth'});
}

async function deleteRecipe(id){
  if(!confirm("Удалить рецепт?")) return;
  await supabase.from('recipes').delete().eq('id', id);
  loadRecipes();
}

document.getElementById('recipe-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const id = document.getElementById('recipe-id').value;
  const title = document.getElementById('title').value.trim();
  const description = document.getElementById('description').value.trim();
  const time = document.getElementById('time').value.trim();
  const ingredients = document.getElementById('ingredients').value.split("\n").map(s => s.trim()).filter(Boolean);
  const steps = document.getElementById('steps').value.split("\n").map(s => s.trim()).filter(Boolean);
  const file = document.getElementById('image-file').files[0];

  let image_url = null;

    /* -------- 1. Загрузка изображения в Storage -------- */
  if (file) {
    const fileName = `recipe_${Date.now()}_${file.name}`;
    
    const { error: uploadError } = await supabase.storage
      .from('images')
      .upload(fileName, file);

    if (uploadError) {
      alert("Ошибка загрузки изображения: " + uploadError.message);
      return;
    }

    // Сразу получаем публичную ссылку
    image_url = supabase
      .storage
      .from('images')
      .getPublicUrl(fileName).data.publicUrl;
  }

  /* -------- 2. Формируем объект для БД -------- */
  const payload = {
    title,
    description,
    time,
    ingredients,
    steps
  };

  if (image_url) {
    payload.image_url = image_url;
  }

  /* -------- 3. Вставка или обновление -------- */
  if (id) {
    // обновление
    const { error } = await supabase
      .from('recipes')
      .update(payload)
      .eq('id', id);

    if (error) {
      alert("Ошибка обновления: " + error.message);
      return;
    }
  } else {
    // вставка
    const { error } = await supabase
      .from('recipes')
      .insert(payload);

    if (error) {
      alert("Ошибка добавления: " + error.message);
      return;
    }
  }  

  e.target.reset();
  document.getElementById('recipe-id').value = '';
  loadRecipes();
});
</script>
<script src="https://kit.fontawesome.com/4eed7af245.js" crossorigin="anonymous"></script>
</body>
</html>
