<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Рецепты — Вкусно</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
</head>
<body>
    <div class="wrap">
        <header>
            <a class="brand" href="index.html">
                <div class="logo">ВК</div>
                <div>
                    <div class="brand-name">Вкусно</div>
                    <div class="brand-sub">Коллекция рецептов</div>
                </div>
            </a>
            <nav aria-label="Навигация">
                <ul>
                    <li><a href="index.html">Главная</a></li>
                    <li><a href="#" aria-current="page">Рецепты</a></li>
                    <li><a href="about.html">О нас</a></li>
                    <li><a href="about.html#contacts">Контакты</a></li>
                </ul>
            </nav>
        </header>

        <main class="recipe-page" id="content2">
            <div class="title-button-back">
                <h1 class="section-title">Подробнее о рецептах</h1>
                <a class="btn-back" href="index.html">&larr; Назад на главную</a>
            </div>
            <!-- Контент с рецептами загружается с помощью JavaScript -->   
        </main>

        <footer>
            <div>© <strong>Вкусно</strong></div>
            <div class="footer-links">
                <a class="footer-link" href="#">Политика</a>
                <a class="footer-link" href="#">Контакты</a>
            </div>
        </footer>
    </div>

<script>
function addWish(form){
    const list = form.closest('.wishes').querySelector('.wish-list');
    const val = form.wish.value.trim();
    if(!val) return;
    const li = document.createElement('li');
    li.textContent = val;
    list.prepend(li);
    form.reset();
}
</script>
<script type="module">
import { supabase } from './assets/js/supabase-init.js';

function normalizeList(field){
  if (!field) return [];
  if (Array.isArray(field)) return field;
  return String(field).split(/\r?\n/).map(s => s.trim()).filter(Boolean);
}

async function renderRecipe(container, r){
  const ingredients = normalizeList(r.ingredients);
  const steps = normalizeList(r.steps);

  const el = document.createElement('article');
  el.className = "recipe-card";
  el.innerHTML = `
    <div class="recipe-grid">
      <div class="info-col">
        <img class="recipe-thumb" src="${r.image_url || 'assets/images/placeholder.png'}" alt="${r.title}">
        <h2>${r.title}</h2>
        <p class="muted">${r.description || ''} ${r.time ? '- ' + r.time : ''}</p>

        <section class="ingredients">
          <h3>Ингредиенты</h3>
          <ul>${ingredients.map(i => `<li>${i}</li>`).join('')}</ul>
        </section>

        <section class="steps">
          <h3>Шаги</h3>
          <ol>${steps.map(s => `<li>${s}</li>`).join('')}</ol>
        </section>

        <section class="wishes" aria-label="Пожелания">
          <h3>Пожелания и советы</h3>
          <form class="wish-form" onsubmit="event.preventDefault(); addWish(this);">
            <input name="wish" type="text" placeholder="Писать сюда" required/>
            <button type="submit">Отправить</button>
          </form>
          <ul class="wish-list" aria-live="polite"></ul>
        </section>
      </div>
    </div>
  `;
  container.appendChild(el);
}

document.addEventListener('DOMContentLoaded', async () => {
  const container = document.getElementById('content2');
  if(!container) return;

  // вставляем сообщение загрузки под заголовком
  const ref = container.querySelector('.title-button-back') || container.firstElementChild;
  const loading = document.createElement('div');
  loading.className = 'loading-message';
  loading.textContent = 'Загрузка...';
  if(ref && ref.parentNode === container) container.insertBefore(loading, ref.nextSibling);
  else container.prepend(loading);

  const params = new URLSearchParams(location.search);
  const id = params.get('id');

  try {
    if(id){
      const { data, error } = await supabase
        .from('recipes')
        .select('*')
        .eq('id', id)
        .single();

      loading.remove();
      if(error || !data){
        container.insertAdjacentHTML('beforeend', '<p>Рецепт не найден.</p>');
        return;
      }
      renderRecipe(container, data);
      return;
    }

    const { data, error } = await supabase
      .from('recipes')
      .select('*')
      .order('created_at', { ascending: false });

    loading.remove();
    if(error || !data) {
      container.insertAdjacentHTML('beforeend', '<p>Не удалось загрузить рецепты.</p>');
      return;
    }
    data.forEach(r => renderRecipe(container, r));
  } catch (e) {
    loading.textContent = 'Ошибка загрузки.';
    console.error(e);
  }
});
</script>
</body>
</html>